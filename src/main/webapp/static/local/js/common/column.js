/** * 栏目相关业务私有js方法 * 2018年04月12日17:00:19 * luxin */// --------------------右键菜单--------------------/** * 右键点击事件方法 */function OnRightClick(event, treeId, treeNode) {    if (!treeNode && event.target.tagName.toLowerCase() != "button" && $(event.target).parents("a").length == 0) {        zTree.cancelSelectedNode();        showRMenu("root", event.clientX, event.clientY);    } else if (treeNode && !treeNode.noR) {        zTree.selectNode(treeNode);        showRMenu("node", event.clientX, event.clientY, treeNode);    }}/** * 显示右键菜单 */function showRMenu(type, x, y, treeNode) {    switch (treeNode.type) {        case 0:// 全部站点            $("#m_edit").hide();            $("#m_del").hide();            $("#m_price").hide();            $("#m_c_price").hide();            $("#m_recommend").hide();            $("#m_c_recommend").hide();            break;        case 4:// 专题            $("#m_add").hide();            break;        default:            $("#m_add").show();            $("#m_edit").show();            $("#m_del").show();            $("#m_price").show();            $("#m_c_price").show();            $("#m_recommend").show();            $("#m_c_recommend").show();            break;    }    // 获取main页面中的元素    var navbar = document.getElementById('navbar');    var sidebar = document.getElementById('sidebar');    var breadcrumbs = document.getElementById('breadcrumbs');    x = x - sidebar.offsetWidth;    y = y - navbar.offsetHeight - breadcrumbs.offsetHeight;    rMenu.css({"top": y + "px", "left": x + "px", "visibility": "visible"});    $("body").bind("mousedown", onBodyMouseDown);}/** * 隐藏右键菜单 */function hideRMenu() {    if (rMenu) rMenu.css({"visibility": "hidden"});    $("body").unbind("mousedown", onBodyMouseDown);}function onBodyMouseDown(event) {    if (!(event.target.id == "rMenu" || $(event.target).parents("#rMenu").length > 0)) {        rMenu.css({"visibility": "hidden"});    }}// --------------------栏目树--------------------/** * 刷新树 */var id = "";function refreshTree() {    var treeObj = $.fn.zTree.getZTreeObj("treeview");    var nodes = treeObj.getSelectedNodes();    id = nodes[0].id;    treeObj.reAsyncChildNodes(null, "refresh", false);}/** * 打开树 */function openTree(id, l) {    var treeObj = $.fn.zTree.getZTreeObj("treeview");    if (id != "") {        var nodes = treeObj.getNodesByParam("id", id, null);        treeObj.expandNode(nodes[0], true, false, true);        treeObj.selectNode(nodes[0]);    } else {        var nodes = treeObj.getNodesByParam("id", 0, null);        var len = -1;        if (l < nodes[0].level) {            return;        }        len = nodes.length;        for (var i = 0; i < len; i++) {            treeObj.expandNode(nodes[i], true, false, false, true);            var child = nodes[i].children;            showztreemenuNum(false, child, l);//递归        }    }}//展开全部ztree树节点(b-(true:ztree-对象;false:树节点),childnodes-子节点或ztree对象,l-要展开到哪个层级)function showztreemenuNum(b, childnodes, l) {    // console.log(childnodes);    var treeObj = $.fn.zTree.getZTreeObj("treeview");    if (b) {        var rootnodes = zTreeObj.getNodes();        showztreemenuNum(false, rootnodes, l);//递归    } else {        var len = -1;        if ((childnodes != null) && ((len = childnodes.length) != null) && len > 0) {            if (l < childnodes[0].level) {                return;            }            for (var i = 0; i < len; i++) {                treeObj.expandNode(childnodes[i], true, false, false, true);                var child = childnodes[i].children;                showztreemenuNum(false, child, l);//递归            }        }    }}/** * 修改栏目树节点 */function editTreeNode() {    var ajaxColumnEdtUrl = contextPath + '/columnManage/column/edit';    hideRMenu();    var selectedNode = zTree.getSelectedNodes()[0];    //要修改的栏目是否为站点    if (selectedNode.level == 0) {        CmMsg.error("根目录不能修改");    } /*else if (selectedNode.level == 1) {//站点        //判断当前用户是否为超管        $.ajax({            url: contextPath + '/columnManage/column/admin',            data: {},            type: "post",            success: function (data) {                if (data.status == 'OK') {//是超管 可以修改站点                    //调栏目修改页                    showColumnsAddDlg("编辑", ajaxColumnEdtUrl + "/" + selectedNode.id, "formDlg", "formDlgOther", function () {                        $("#columnsId").val(selectedNode.id);                        id = selectedNode.id;                        refreshTree();                        openTree(selectedNode.id);                    }, false, BootstrapDialog.SIZE_WIDE);                } else if (data.status == 'ERROR') {//不是超管                    CmMsg.error(data.message, -1);                } else if (data.status == 'TIMEOUT') {                    CmMsg.error(data.message, -1);                } else {                    CmMsg.error("失败或其他错误", -1);                }            }        });    }*/ else {        //调栏目修改页        showColumnsAddDlg("编辑", ajaxColumnEdtUrl + "/" + selectedNode.id, "formDlg", "formDlgOther", function () {            $("#columnsId").val(selectedNode.id);            id = selectedNode.id;            refreshTree();            openTree(selectedNode.id);        }, false, BootstrapDialog.SIZE_WIDE);    }}/** * 增加栏目树节点 */function addTreeNode() {    var ajaxColumnAddUrl = contextPath + '/columnManage/column/add';    hideRMenu();    // console.log(zTree.getSelectedNodes()[0]);    var selectedNode = zTree.getSelectedNodes()[0];    //要修改的栏目是否为站点    if (selectedNode.level == 0) {//增加站点        //判断当前用户是否为超管        $.ajax({            url: contextPath + '/columnManage/column/admin',            data: {},            type: "post",            success: function (data) {                if (data.status == 'OK') {//是超管 可以增加站点                    //调栏目新增页                    showColumnsAddDlg("新增", ajaxColumnAddUrl + "/" + selectedNode.id, "formDlg", "formDlgOther", function () {                        $("#columnsId").val(selectedNode.id);                        id = selectedNode.id;                        refreshTree();                        openTree(selectedNode.id);                    }, false, BootstrapDialog.SIZE_WIDE);                } else if (data.status == 'ERROR') {//不是超管                    CmMsg.error(data.message, -1);                } else if (data.status == 'TIMEOUT') {                    CmMsg.error(data.message, -1);                } else {                    CmMsg.error("失败或其他错误", -1);                }            }        });    } else {        showColumnsAddDlg("新增", ajaxColumnAddUrl + "/" + selectedNode.id, "formDlg", "formDlgOther", function () {            $("#columnsId").val(selectedNode.id);            id = selectedNode.id;            refreshTree();            openTree(selectedNode.id);        }, false, BootstrapDialog.SIZE_WIDE);    }}/** *删除栏目树节点 */function removeTreeNode() {    var ajaxColumnDelUrl = contextPath + '/columnManage/column/remove';    hideRMenu();    // console.log(zTree.getSelectedNodes()[0]);    var selectedNode = zTree.getSelectedNodes()[0];    //要修改的栏目是否为站点    if (selectedNode.level == 0) {        CmMsg.error("无法修改");    } else if (selectedNode.level == 1) {//站点        //判断当前用户是否为超管        $.ajax({            url: contextPath + '/columnManage/column/admin',            data: {},            type: "post",            success: function (data) {                if (data.status == 'OK') {//是超管 可以修改站点                    doDeleteByTree(ajaxColumnDelUrl + "/" + selectedNode.id, "table-data", function () {                        $("#columnsId").val(selectedNode.pId);                        var nodes = zTree.getSelectedNodes();                        if (nodes && nodes.length > 0) {                            zTree.removeNode(nodes[0]);                        }                        initTable('table-data', columns, ajaxListUrl, 'frmSearch');                    });                } else if (data.status == 'ERROR') {//不是超管                    CmMsg.error(data.message, -1);                } else if (data.status == 'TIMEOUT') {                    CmMsg.error(data.message, -1);                } else {                    CmMsg.error("失败或其他错误", -1);                }            }        });    } else {        doDeleteByTree(ajaxColumnDelUrl + "/" + selectedNode.id, "table-data", function () {            $("#columnsId").val(selectedNode.pId);            var nodes = zTree.getSelectedNodes();            if (nodes && nodes.length > 0) {                if (nodes[0].children && nodes[0].children.length > 0) {                    var msg = "If you delete this node will be deleted along with sub-nodes. \n\nPlease confirm!";                    if (confirm(msg) == true) {                        zTree.removeNode(nodes[0]);                    }                } else {                    zTree.removeNode(nodes[0]);                }            }            initTable('table-data', columns, ajaxListUrl, 'frmSearch');        });    }}/** * 定价 */function priceTreeNode() {    hideRMenu();    var selectedNode = zTree.getSelectedNodes()[0];    var columnsId = selectedNode.id;    var level = selectedNode.level;    showSelectDlg("选择栏目", contextPath + '/pay/product/select/2', ["Select_table-data"],        function (obj) {            for (var i = 0; i < obj.length; i++) {                var id = obj[i].id;                $.ajax({                    url: contextPath + '/pay/productRel/add',                    data: {                        "bizId": columnsId,                        "productId": id,                        "level": level                    },                    type: "post",                    async: false,                    success: function (data) {                        if (data.status == 'OK') {                            CmMsg.info(data.message, -1);                        } else if (data.status == 'ERROR') {                            CmMsg.error(data.message, -1);                        } else if (data.status == 'TIMEOUT') {                            CmMsg.error(data.message, -1);                        } else {                            CmMsg.error("失败或其他错误", -1);                        }                    }                });            }            refreshTree();        }, BootstrapDialog.SIZE_WIDE);}/** * 取消定价 */function unPriceTreeNode() {    hideRMenu();    var selectedNode = zTree.getSelectedNodes()[0];    $.ajax({        url: contextPath + '/pay/productRel/deleteByBizId',        data: {            "columnsId": selectedNode.id,        },        type: "post",        success: function (data) {            if (data.status == 'OK') {                CmMsg.info(data.message, -1);                refreshTree();            } else if (data.status == 'ERROR') {                CmMsg.error(data.message, -1);            } else if (data.status == 'TIMEOUT') {                CmMsg.error(data.message, -1);            } else {                CmMsg.error("失败或其他错误", -1);            }        }    });}/** * 推荐 */function recommend() {    hideRMenu();    var selectedNode = zTree.getSelectedNodes()[0];    var columnsId = selectedNode.id;    $.ajax({        url: contextPath + '/columnManage/column/setRecommend',        data: {            "columnId": columnsId,            "type": 1        },        type: "post",        async: false,        success: function (data) {            if (data.status == 'OK') {                CmMsg.info(data.message, -1);            } else if (data.status == 'ERROR') {                CmMsg.error(data.message, -1);            } else if (data.status == 'TIMEOUT') {                CmMsg.error(data.message, -1);            } else {                CmMsg.error("失败或其他错误", -1);            }        }    });}/** * 取消推荐 */function unRecommend() {    hideRMenu();    var selectedNode = zTree.getSelectedNodes()[0];    var columnsId = selectedNode.id;    $.ajax({        url: contextPath + '/columnManage/column/setRecommend',        data: {            "columnId": columnsId,            "type": 2        },        type: "post",        async: false,        success: function (data) {            if (data.status == 'OK') {                CmMsg.info(data.message, -1);            } else if (data.status == 'ERROR') {                CmMsg.error(data.message, -1);            } else if (data.status == 'TIMEOUT') {                CmMsg.error(data.message, -1);            } else {                CmMsg.error("失败或其他错误", -1);            }        }    });}function showColumnsAddDlg(title, ajaxUrl, formId, otherFormId, callback, hasFile, size) {    BootstrapDialog.show({        type: BootstrapDialog.TYPE_PRIMARY,        size: size,        closable: true,        draggable: true,        closeByBackdrop: false,        title: title,        //加载远程页面        message: $('<div></div>').load(ajaxUrl),        buttons: [{            id: 'btn-Cancel',            icon: 'glyphicon glyphicon-remove',            label: '关闭',            cssClass: 'btn-default',            autospin: false,            action: function (dialogRef) {                dialogRef.close();            }        }, {            id: 'btn-OK',            icon: 'glyphicon glyphicon-check',            label: '确认',            cssClass: 'btn-primary',            autospin: false,            action: function (dialogRef) {                var $button = this;                $button.disable();                $button.toggleSpin(true);                var flag = true;                if ($('#' + formId).valid()) {                    var data = {};                    if (otherFormId != null) {                        flag = $('#' + otherFormId).valid();                    }                    if (flag) {                        data.main = getParams(formId);//栏目基本信息                        data.other = getParams(otherFormId);//栏目附属信息//                        data.image = getParams("formDlgImage");//栏目图片信息表                        // (JSON.stringify(data));                        $.ajax({                            url: ajaxUrl,                            type: "post",                            contentType: "application/json",                            data: JSON.stringify(data),                            success: function (data) {                                if (data.status == 'OK') {                                    dialogRef.close();                                    CmMsg.success(data.message, -1);                                    if (callback) {                                        callback();                                    }                                } else if (data.status == 'ERROR') {                                    CmMsg.error(data.message, -1);                                } else if (data.status == 'TIMEOUT') {                                    CmMsg.error(data.message, -1);                                } else {                                    CmMsg.error("保存失败或其他错误", -1);                                }                                $button.toggleSpin(false);                                $button.enable();                            }                        });                    } else {                        $button.toggleSpin(false);                        $button.enable();                    }                } else {                    $button.toggleSpin(false);                    $button.enable();                }            }        }]    });}