package cn.com.evo.integration.xjnt;import cn.com.evo.admin.manage.domain.entity.Province;import cn.com.evo.cms.domain.entity.cms.Picture;import cn.com.evo.cms.domain.entity.cms.Video;import cn.com.evo.integration.common.ConstantFactory;import cn.com.evo.integration.common.utils.FileToMulFile;import cn.com.evo.integration.xjnt.common.ConstantEnum;import cn.com.evo.provincial.service.AbstractProvincialServiceImpl;import com.frameworks.utils.FtpUtils;import org.apache.commons.lang3.StringUtils;import org.springframework.beans.BeanUtils;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.stereotype.Service;import org.springframework.transaction.annotation.Transactional;import org.springframework.web.multipart.MultipartFile;import java.util.List;/** * @Description: 新疆广电省网接口实现 * @author: lu.xin * @create: 2019-03-14 9:57 AM **/@Service@Transactionalpublic class XjntContentSynServiceImpl extends AbstractProvincialServiceImpl {    @Autowired    private XjntAuthServiceImpl xjntAuthService;    /**     * 新疆广电，同步图片至ftp     *     * @param picture  图片对象     * @param province 省网配置信息     */    @Override    public void registImage(Picture picture, Province province, boolean deleteFlag) {        try {            String command = "chmod 777 " + picture.getCloudPath();            Runtime.getRuntime().exec(command).waitFor();            MultipartFile multipartFile = FileToMulFile.getMulFileByPath(picture.getCloudPath(), picture.getFileName());            // 匹配省网逻辑            String name = picture.getFileName();            String path = "/" + name;            FtpUtils.upload(province.getFtpUrl(), province.getFtpUser(),                    province.getFtpPassword(), Integer.valueOf(province.getFtpPort()), multipartFile, path);        } catch (Exception e) {            throw new RuntimeException("上传资源至ftp服务器异常：" + e.getMessage(), e);        }    }    @Override    public Video getPlayURL(String accesstoken, List<Video> temps, String appId) {        Video video = new Video();        try {            // 针对视开项目/亲多多ott项目需要单独获取播放地址            if (ConstantFactory.map.get(ConstantEnum.four_k_app_id.getKey()).equals(appId) ||                    ConstantFactory.map.get(ConstantEnum.qindd_app_id.getKey()).equals(appId)) {                if (temps.size() > 0) {                    BeanUtils.copyProperties(temps.get(0), video);                    String url = xjntAuthService.getPlayUrl(accesstoken, video.getUrl());                    if (StringUtils.isBlank(url)) {                        throw new RuntimeException("通过局方接口获取播放地址异常或错误!!!可能的原因有三方id错误或内容未发布!!!");                    } else {                        video.setUrl(url);                    }                    return video;                } else {                    throw new RuntimeException("该内容未配置相关视频资源");                }            } else {                if (temps.size() > 0) {                    BeanUtils.copyProperties(temps.get(0), video);                    return video;                } else {                    throw new RuntimeException("该内容未配置相关视频资源");                }            }        } catch (Exception e) {            throw new RuntimeException("调用新疆广电获取播放地址异常!!!" + e.getMessage(), e);        }    }}